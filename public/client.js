class ChatClient{constructor(){this.currentUser=null;this.currentRecipient=null;this.socket=null;this.typingTimeout=null;this.lastSentMessageId=null;this.tempClearedMessages=null;this.initializeSocket();this.setupEventListeners()}initializeSocket(){this.socket=io();this.socket.on("connect",()=>{if(this.currentUser)this.socket.emit("user-online",this.currentUser.username)});this.socket.on("new-message",m=>{this.displayMessage(m);this.updateChatListUI()});this.socket.on("message-sent",m=>{this.displayMessage(m);this.updateChatListUI()});this.socket.on("message-status-update",d=>{this.updateMessageStatus(d.messageId,d.status)});this.socket.on("message-unsent",d=>{const m=document.querySelector(`[data-message-id="${d.messageId}"]`);if(m){const t=m.querySelector(".message-text");if(t)t.innerHTML="<em style='color:#999;'>This message was unsent</em>"}this.updateChatListUI()});this.socket.on("chat-cleared",d=>{this.tempClearedMessages=d;document.getElementById("messagesContainer").innerHTML="<div class='no-messages'>No messages yet. Start a conversation!</div>";this.showUndoNotification();this.updateChatListUI()});this.socket.on("chat-restored",d=>{if(this.currentRecipient===d.chatUser)this.loadChatMessages();this.tempClearedMessages=null;this.hideUndoNotification();this.updateChatListUI()});this.socket.on("user-typing",d=>{this.showTypingIndicator(d.username,d.isTyping)});this.socket.on("user-status-change",()=>this.updateChatListUI())}setupEventListeners(){const s=document.getElementById("signupFormElement"),q=document.getElementById("quickLoginForm"),e=document.getElementById("emailLoginFormElement");if(s)s.addEventListener("submit",x=>{x.preventDefault();this.handleRegistration()});if(q)q.addEventListener("submit",x=>{x.preventDefault();this.handleQuickLogin()});if(e)e.addEventListener("submit",x=>{x.preventDefault();this.handleEmailLogin()});const send=document.getElementById("sendBtn"),uns=document.getElementById("unsendMessageBtn"),msg=document.getElementById("messageInput"),search=document.getElementById("searchBtn"),logout=document.getElementById("logoutBtn"),menu=document.getElementById("chatMenuBtn"),clear=document.getElementById("clearChatBtn");if(send)send.onclick=()=>this.sendMessage();if(uns)uns.onclick=()=>this.unsendLastMessage();if(menu)menu.onclick=x=>{x.stopPropagation();this.toggleChatMenu()};if(clear)clear.onclick=()=>{this.clearChat();this.hideChatMenu()};if(search)search.onclick=()=>this.searchUsers();if(logout)logout.onclick=()=>this.logout();document.addEventListener("click",()=>this.hideChatMenu());if(msg)msg.addEventListener("keypress",x=>{if(x.key==="Enter")this.sendMessage();else this.handleTyping()});const sid=document.getElementById("quickLoginUserId");if(sid)this.setupStudentIdFormatting(sid);const si=document.getElementById("searchInput");if(si){this.setupStudentIdFormatting(si);si.addEventListener("keypress",x=>{if(x.key==="Enter")this.searchUsers()})}}async handleRegistration(){const u=document.getElementById("signupUsername").value.trim(),e=document.getElementById("signupEmail").value.trim(),p=document.getElementById("signupPassword").value;if(!u||!e||!p)return this.showStatus("Please fill in all fields","error");try{const r=await fetch("/api/register",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:u,email:e,password:p})}),d=await r.json();if(d.success){this.currentUser=d.user;window.chatClient=this;this.socket.emit("user-online",this.currentUser.username);this.showChatInterface();this.showStatus(d.message,"success")}else this.showStatus(d.error,"error")}catch{x=>this.showStatus("Registration failed.","error")}}async handleQuickLogin(){const id=document.getElementById("quickLoginUserId").value.trim();if(!id)return this.showStatus("Enter Student ID","error");try{const r=await fetch("/api/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:id})}),d=await r.json();if(d.success){this.currentUser=d.user;window.chatClient=this;this.socket.emit("user-online",this.currentUser.username);this.showChatInterface();this.showStatus(d.message,"success")}else this.showStatus(d.error,"error")}catch{x=>this.showStatus("Login failed.","error")}}async handleEmailLogin(){const e=document.getElementById("emailLoginEmail").value.trim(),p=document.getElementById("emailLoginPassword").value;if(!e||!p)return this.showStatus("Fill all fields","error");try{const r=await fetch("/api/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:p})}),d=await r.json();if(d.success){this.currentUser=d.user;window.chatClient=this;this.socket.emit("user-online",this.currentUser.username);this.showChatInterface();this.showStatus(d.message,"success")}else this.showStatus(d.error,"error")}catch{x=>this.showStatus("Login failed.","error")}}async startChat(u){if(!this.currentUser)return this.showStatus("Login first","error");this.currentRecipient=u;await fetch(`/api/messages/${this.getChatId(this.currentUser.username,u)}`);document.getElementById("chatUsername").textContent=`Chat with ${u}`;document.getElementById("chatHeader").style.display="flex";document.getElementById("chatInput").style.display="block";document.getElementById("messageInput").disabled=false;document.getElementById("sendBtn").disabled=false;document.getElementById("messageInput").focus();document.getElementById("searchResults").innerHTML="";await this.loadChatMessages();await this.updateChatListUI();this.showStatus(`Started chat with ${u}`,"success")}async loadChatMessages(){if(!this.currentRecipient)return;const c=document.getElementById("messagesContainer");c.innerHTML="";try{const r=await fetch(`/api/messages/${this.getChatId(this.currentUser.username,this.currentRecipient)}`),d=await r.json(),m=d.messages||d;if(m.length===0){c.innerHTML="<div class='no-messages'>No messages yet.</div>";return}m.forEach(x=>this.displayMessage(x));c.scrollTop=c.scrollHeight}catch(x){}}displayMessage(m){const c=document.getElementById("messagesContainer"),d=document.createElement("div");d.className=`message ${m.from===this.currentUser.username?"own":"received"}`;d.dataset.messageId=m.id;d.innerHTML=`<div class="message-avatar">${m.from[0].toUpperCase()}</div><div class="message-content"><div class="message-bubble"><div class="message-text">${m.text}</div><div class="message-meta"><span class="message-time">${new Date(m.timestamp).toLocaleTimeString()}</span></div></div></div>`;c.appendChild(d);c.scrollTop=c.scrollHeight}
updateMessageStatus(id,s){const m=document.querySelector(`[data-message-id="${id}"]`);if(!m)return;let el=m.querySelector(".message-status");if(!el){el=document.createElement("span");el.className="message-status";m.querySelector(".message-meta").appendChild(el)}el.textContent=s}sendMessage(){const i=document.getElementById("messageInput"),t=i.value.trim();if(!t||!this.currentRecipient)return;const id="msg_"+Date.now()+"_"+Math.random().toString(36).substr(2,9);this.socket.emit("send-message",{from:this.currentUser.username,to:this.currentRecipient,text:t,messageId:id});this.lastSentMessageId=id;i.value="";this.stopTyping()}unsendLastMessage(){if(!this.lastSentMessageId)return;this.socket.emit("unsend-message",{messageId:this.lastSentMessageId,from:this.currentUser.username,to:this.currentRecipient});this.lastSentMessageId=null}async searchUsers(){const q=document.getElementById("searchInput").value.trim();if(!q)return;try{const r=await fetch(`/api/users/search?query=${encodeURIComponent(q)}&currentUser=${encodeURIComponent(this.currentUser.username)}`),d=await r.json();this.displaySearchResults(d)}catch(x){}}displaySearchResults(r){const c=document.getElementById("searchResults");c.innerHTML="";if(r.length===0){c.innerHTML="<div style='padding:1rem;text-align:center;color:#666;'>No users found</div>";return}r.forEach(u=>{const d=document.createElement("div");d.className="search-result-item";d.innerHTML=`<div><div style="font-weight:bold;">${u.username}</div><div style="font-size:0.8rem;color:#666;">Student ID: ${u.userId}</div></div><button class="add-user-btn" onclick="chatClient.startChat('${u.username}')">Chat</button>`;c.appendChild(d)})}handleTyping(){if(!this.currentRecipient)return;this.socket.emit("typing-start",{from:this.currentUser.username,to:this.currentRecipient});clearTimeout(this.typingTimeout);this.typingTimeout=setTimeout(()=>this.stopTyping(),3000)}stopTyping(){if(!this.currentRecipient)return;this.socket.emit("typing-stop",{from:this.currentUser.username,to:this.currentRecipient})}showTypingIndicator(u,b){const t=document.getElementById("typingIndicator");if(b){t.innerHTML=`${u} is typing...`;t.style.display="block"}else t.style.display="none"}async updateChatListUI(){if(!this.currentUser)return;try{const r=await fetch(`/api/chats/${this.currentUser.username}`),d=await r.json(),c=d.chats||d,l=document.getElementById("userList");l.innerHTML="";c.forEach(ch=>{const li=document.createElement("li");li.className="user-item";li.onclick=()=>this.startChat(ch.username);li.innerHTML=`<div class="chat-item-header"><div class="chat-item-avatar">${ch.username[0]}</div><div class="chat-item-info"><div class="chat-item-name">${ch.username}</div><div class="chat-item-preview">${ch.lastMessage||""}</div></div></div>`;l.appendChild(li)})}catch(x){}}clearChat(){this.socket.emit("clear-chat",{username:this.currentUser.username,chatUser:this.currentRecipient})}undoClearChat(){this.socket.emit("undo-clear-chat",{username:this.currentUser.username,chatUser:this.currentRecipient})}showUndoNotification(){document.getElementById("undoNotification").style.display="block"}hideUndoNotification(){document.getElementById("undoNotification").style.display="none"}showChatInterface(){document.getElementById("authScreen").style.display="none";document.getElementById("mainApp").style.display="flex";document.getElementById("currentUsername").textContent=this.currentUser.username;document.getElementById("currentUserId").textContent=this.currentUser.userId;document.getElementById("currentUserAvatar").textContent=this.currentUser.username[0].toUpperCase();setTimeout(()=>this.updateChatListUI(),300)}logout(){this.currentUser=null;this.currentRecipient=null;document.getElementById("authScreen").style.display="flex";document.getElementById("mainApp").style.display="none";document.getElementById("quickLoginUserId").value="";document.getElementById("signupEmail").value="";document.getElementById("signupUsername").value="";document.getElementById("signupPassword").value="";document.getElementById("emailLoginEmail").value="";document.getElementById("emailLoginPassword").value="";this.showStatus("Logged out","success")}showStatus(m,t="info"){const el=document.getElementById("statusMessage");el.textContent=m;el.className=`status-message status-${t}`;el.style.display="block";setTimeout(()=>el.style.display="none",5000)}getChatId(a,b){return[a,b].sort().join("_")}}let chatClient;document.addEventListener("DOMContentLoaded",()=>{chatClient=new ChatClient()});
